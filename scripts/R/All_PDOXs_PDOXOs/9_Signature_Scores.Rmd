---
title: "9.  PDOX and PDOXO (P20-11 & P20-23): Signature scores"
author: "Romuald Parmentier"
date: "2025-04-14"
output: html_document
---

# Prepare environement

```{r Libraries, fonctions, palettes, paths, message = F}

# Libraries
library(SingleCellExperiment)
library(Seurat)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggbeeswarm)
library(gridExtra)
library(scater)
library(org.Hs.eg.db)
library(ComplexHeatmap)
library(ggpubr)
library(AnnotationHub)
library(msigdbr)
library(clusterProfiler)
library(stringr)
library(rstatix)

# Functions and palettes
source("/scicore/home/wykopa75/GROUP/rparmentier/sc_RNAseq/Projects/Prostate/Xenograft_Models/Xenograft_Models_Custom_Functions.R")
source("/scicore/home/wykopa75/GROUP/rparmentier/sc_RNAseq/Projects/Prostate/Xenograft_Models/Xenograft_Models_Color_Palettes.R")

# Create output path
out_path = create_exp_folder(
  organ = "Prostate" ,
  project = "Xenograft_Models",
  samples_ID = "All_PDOXs_PDOXOs",
  exp = "9_Signature_Scores"
)

```

```{r Load sce object}

file_path = get_exp_file_path(
  organ = "Prostate" ,
  project = "Xenograft_Models",
  samples_ID = "All_PDOXs_PDOXOs",
  prev_exp = "6.0_Dimension_Reduction_No_Regression",
  pattern = "sce_obj.rds")

sce_obj = readRDS(file_path)

```

```{r Transform sce to seurat }

seurat_comb = as.Seurat(
  x = sce_obj, 
  counts = "counts", 
  data = "logcounts"
)

# Set the originalexp (aka "RNA" as the default assay)
DefaultAssay(seurat_comb) = "originalexp"

# Adds scale.data slot
seurat_comb = ScaleData(seurat_comb)

```

# Select gene sets to perforn signature score analysis

- List of the gene sets that will be used to calculate gene signature scores later
```{r Load HALLMARK, GOBP, GOMF and C2 gene sets}

HALLMARK = read.gmt("/scicore/home/wykopa75/GROUP/rparmentier/sc_RNAseq/Projects/Sequencing_Data/Gene_sets/MSigDB_HALLMARKS_hs_v2023_2.gmt")
GOBP = read.gmt("/scicore/home/wykopa75/GROUP/rparmentier/sc_RNAseq/Projects/Sequencing_Data/Gene_sets/MSigDB_C5_GO_Biological_Process.gmt")
GOMF = read.gmt("/scicore/home/wykopa75/GROUP/rparmentier/sc_RNAseq/Projects/Sequencing_Data/Gene_sets/MSigDB_C5_GO_Molecular_Function.gmt")
C2 = read.gmt("/scicore/home/wykopa75/GROUP/rparmentier/sc_RNAseq/Projects/Sequencing_Data/Gene_sets/MSigDB_C2_Curated_Gensets.gmt")


list_collection = list(
  "C2" = C2, #BIOCARTA, KEGG_MEDICUS, PID, REACTOME, WIKIPATHWAY, KEGG_LEGACY
  "HALLMARK" = HALLMARK,
  "GOBP" = GOBP,
  "GOMF" = GOMF)

# Make a single df out of all gene sets fron differnet collecitons
gene_set_collection_df = data.table::rbindlist(list_collection)

```

- Gene sets found enriched or suppressed in PDOX vs PDOXOS in one of the two lines (P20-11 or P20-23)
```{r Extract enriched pathways terms}

# Load gse object for both patient
###################################

patient_id =  c("P20-11","P20-23")

file_path = get_exp_file_path(
  organ = "Prostate" ,
  project = "Xenograft_Models",
  samples_ID = "All_PDOXs_PDOXOs",
  prev_exp = "8_Gene_Set_Enrichment_Analysis/Gene_Set_Enrichment_Analysis",
  pattern = "gse_objects_per_collection_P20-.*\\.rds")

gse_objects_list = lapply(file_path, readRDS)
names(gse_objects_list) = patient_id

# Extract enriched terms for both patients
##########################################
enriched_terms_list = list()

for(model_id in seq_along(gse_objects_list)){
  
  model_name = names(gse_objects_list)[model_id]
  gse_list = gse_objects_list[[model_id]]
  
  # Make a single df out of the gse results
  gse_results_df = lapply(gse_list, function(gse){rbind(gse@result)})
  gse_results_df = data.table::rbindlist(gse_results_df)
  
  # Select only enriched pathways
  gse_enriched_pathways = as.data.frame(gse_results_df$ID)
  colnames(gse_enriched_pathways) = "term"
  
  enriched_terms_list[[model_name]] = gse_enriched_pathways
  
}

GSEA_enriched_terms = data.table::rbindlist(enriched_terms_list)
GSEA_enriched_terms = as_tibble(GSEA_enriched_terms) %>% pull(term)
GSEA_enriched_terms = unique(as.character(GSEA_enriched_terms))

```

- Gene sets of interest to check (e.g: PI3K-AKT-mTOR, ANDROGEN_RESPONSE)
```{r Pattern matching to select pathway of interest }

targetted_terms <- gene_set_collection_df %>% 
  filter(str_detect(term, pattern = "PI3K|ANDROGEN|HALLMARK")) %>% 
  pull(term)

targetted_terms = unique(as.character(targetted_terms))

```

- Custom gene sets A
```{r Create signature with custom gene list}

custom_gene_sets_df = tibble()

# ALIMONTI senescence signature score
# (https://www.nature.com/articles/s41467-022-29824-1#Sec37)
############################################################

# Check presence and alias if needed
allias = sapply(c("P16", "P15", "P19", "P21", "P27" , "PAI-1"), function(gene){
  check_aliase(
    sce = sce_obj, 
    gene = gene )
}
)

gene_set_df = tibble(
  term = "ALIMONTI_SENESCENCE",
  gene = allias
)

# Add the custom pahway to a df
custom_gene_sets_df = bind_rows(custom_gene_sets_df, gene_set_df)

# Cluster 5 markers
###################

file_path = get_exp_file_path(
  organ = "Prostate" ,
  project = "Xenograft_Models",
  samples_ID = "P20-11_21d_ADT",
  prev_exp = "8_Differential_Expression",
  pattern = "DE_Table_All_Clusters.csv")

all_cluster_DE_genes = read.csv2(file_path)

# Extract genes
cluster_5_genes = all_cluster_DE_genes %>% 
  filter(cluster == 5 & avg_log2FC > 3 & pct.1 > 0.7) %>%
  pull(gene) # 22 genes

# Check presence and alias if needed
allias = sapply(cluster_5_genes, function(gene){check_aliase(sce = sce_obj, gene = gene)})

# Add tern to the custom_term table
gene_set_df = tibble(
  term = "CLUSTER_5_ADT",
  gene = allias
)

# Add the custom pahway to a df
custom_gene_sets_df = bind_rows(custom_gene_sets_df, gene_set_df)

```

- Assemble of gene sets previously selected: GSEA-enriched + targetted + custom
```{r Assemble gene sets of choice to test signature}

# Gater all selected gene terms from MsigDB
MSigDB_terms = c(targetted_terms)
MSigDB_terms = c(GSEA_enriched_terms, targetted_terms)

# Select gene set to score withing the MsigDB collection df
gene_sets_to_score_df = gene_set_collection_df %>%
  filter(term %in% MSigDB_terms)

# Add custom pathway to the term to score df
gene_sets_to_score_df = bind_rows(gene_sets_to_score_df, custom_gene_sets_df)

print(paste0(length(unique(gene_sets_to_score_df$term)), " pathways to score"))

```

############################################################################
############################################################################

# Calculate signature scores

```{r Add signature score to sce object }

terms_col_idx = str_detect(string = colnames(colData(sce_obj)), pattern = "score")
already_score_terms = str_remove(string = colnames(colData(sce_obj))[terms_col_idx],pattern = "_score")
terms_to_score_names = setdiff(unique(gene_sets_to_score_df$term), already_score_terms )

# Select only gene sets that havn't been scored yet
gene_sets_to_score_df = gene_sets_to_score_df %>%
  filter(term %in% terms_to_score_names )

for(pathway in unique(gene_sets_to_score_df$term)){
  
  print(paste0("Enrich plot for pathway: ", pathway))
  
  # Select genes on which calculating the signature score
  genes_of_interest <- gene_sets_to_score_df %>% filter(term == pathway)
  genes_of_interest = as.vector(genes_of_interest$gene)
  
  # Calculate signature score and add it to seurat object as an alternative assays (signature only + signature genes only)
  seurat_comb = calculate_signature_score(
    assay_name = "originalexp",
    seurat_object = seurat_comb, 
    signature_name = pathway, 
    signature_genes = genes_of_interest
  )
  
  # Transfer the signature score from seurat to sce (score in colData, genes of the signature marked in the rowData)
  sce_obj = add_signature_score_to_sce(
    sce_object = sce_obj,
    seurat_object = seurat_comb,
    signature_name = pathway,
    seurat_assay = paste0(pathway, "_score_only"),
    signature_genes = genes_of_interest
  )
  
}

```

```{r Export scored sce object}

saveRDS(
  object = sce_obj,
  file = paste0(out_path, time_stamp(),"sce_obj_scored.rds")
)

```

############################################################################
############################################################################

# Visualize signature scores


```{r Reload sce object if needed}

file_path = get_exp_file_path(
  organ = "Prostate" ,
  project = "Xenograft_Models",
  samples_ID = "All_PDOXs_PDOXOs",
  prev_exp = "9_Signature_Scores",
  pattern = "sce_obj_scored.rds")

sce_obj = readRDS(file_path)

# Export metadata
md = colData(sce_obj)
md = as_tibble(md)

```

## Violin plot 

GPT guided: checked and ok, except that the box with p and r is spanning over the whole x axis instead of pink vs blue 

- Violin plot of all the selected gene sets selected

- Stats performed : 
  -> PDOX vs PDOXO (all passages merged)
  -> ANDROGEN_RESPONSE and HALLMARK_MTORC1_SIGNALING
  -> Wilcoxon test (non-parametric to avoid assume normality)
  -> Also calculates the effect size to assess how big is the biological effect assosicated to the pvalue
     (< 0.2 = small, < 0.5 = Medium, 0.8 > Substential)
     
```{r Violin plot: all selected pathways - split by samples}

gene_signature_scores <- colnames(md)[grepl("score", colnames(md))]
pathway_id <- 1
plot_list  <- list()

for (gene_signature in gene_signature_scores) {
  
  # ---------- (A) Per-facet stats (Wilcoxon + effect size) ----------
  # Keep only the two systems you compare
  df_sig <- md %>%
    filter(Model_System %in% c("Xenograft", "Xenograft_Organoids")) %>%
    mutate(Score = as.numeric(.data[[gene_signature]]))
  
  # Wilcoxon per Model_ID
  p_tab <- df_sig %>%
    group_by(Model_ID) %>%
    wilcox_test(Score ~ Model_System) %>%
    mutate(p.label = rstatix::p_format(p, accuracy = 1e-3))
  
  # Effect size per Model_ID
  eff_tab <- df_sig %>%
    group_by(Model_ID) %>%
    wilcox_effsize(Score ~ Model_System) %>%
    select(Model_ID, effsize)
  
  # Panel geometry: x-span (all Short_ID in each facet) & y-position (top of data)
  span_tab <- df_sig %>%
    group_by(Model_ID) %>%
    summarise(
      n_x = n_distinct(Short_ID),
      x_min = 0.5,                # start just left of the first x tick
      x_max = n_x + 0.5,          # end just right of the last x tick
      x_mid = (x_min + x_max)/2,  # center for the label
      y_top = max(Score, na.rm = TRUE)
    )
  
  # Merge stats + geometry & build label "p = ... | r = ..."
  ann_df <- p_tab %>%
    left_join(eff_tab, by = "Model_ID") %>%
    left_join(span_tab, by = "Model_ID") %>%
    mutate(
      label      = paste0("p = ", p.label, "   |   r = ", round(effsize, 2)),
      y.position = y_top + 0.05 * diff(range(df_sig$Score, na.rm = TRUE)), # 5% headroom
      y.cap      = y.position - 0.02 * diff(range(df_sig$Score, na.rm = TRUE)) # small caps
    )
  
  # ---------- (B) Plot ----------
  p <- ggplot(md, aes(x = Short_ID, y = .data[[gene_signature]], fill = Model_System)) +
    geom_violin(alpha = 0.8, position = position_dodge(width = 0.8), scale = "width") +
    geom_boxplot(width = 0.1, position = position_dodge(width = 0.8), alpha = 0.5, outlier.shape = NA) +
    geom_hline(yintercept = 0, linetype = "dotted", color = "black", linewidth = 0.6) +
    scale_fill_manual(values = c("Xenograft_Organoids" = "#ADD8E6", "Xenograft" = "#FFD1DC")) +
    labs(
      title = paste0("Signature score: ", gene_signature),
      x = "Sample",
      y = "Signature score",
      fill = "Data Type"
    ) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
      strip.text = element_text(size = 12),
      strip.background = element_rect(fill = "grey90", color = "grey40", linewidth = 0.5),
      panel.background = element_rect(fill = "transparent", color = NA),
      plot.background  = element_rect(fill = "transparent", color = NA),
      panel.grid.major = element_line(color = "grey90"),
      panel.grid.minor = element_line(color = "grey95"),
      panel.border     = element_rect(color = "grey60", fill = NA, linewidth = 0.5)
    ) +
    facet_grid(~ Model_ID, scales = "free_x")
  
  # ---------- (C) Add the panel-level comparison bar + label ----------
  # Horizontal bar
  p <- p + geom_segment(
    data = ann_df,
    aes(x = x_min, xend = x_max, y = y.position, yend = y.position),
    inherit.aes = FALSE, linewidth = 0.5
  )
  # End caps
  p <- p + geom_segment(
    data = ann_df,
    aes(x = x_min, xend = x_min, y = y.cap, yend = y.position),
    inherit.aes = FALSE, linewidth = 0.5
  ) +
    geom_segment(
      data = ann_df,
      aes(x = x_max, xend = x_max, y = y.cap, yend = y.position),
      inherit.aes = FALSE, linewidth = 0.5
    )
  # Centered label
  p <- p + geom_label(
    data = ann_df,
    aes(x = x_mid, y = y.position, label = label),
    inherit.aes = FALSE,
    size = 3,
    label.r = unit(0.1, "lines"),
    label.padding = unit(0.1, "lines"),
    fill = "white",
    label.size = 0.25
  )
  
  plot_list[[pathway_id]] <- p
  pathway_id <- pathway_id + 1
}

# ---------- (D) Save multi-page PDF ----------
multiple_page_layout <- gridExtra::marrangeGrob(grobs = plot_list, nrow = 1, ncol = 1)

ggsave(
  plot     = multiple_page_layout,
  filename = paste0(out_path, time_stamp(), "plots_violin_signature_scores_all_terms_with_bars.pdf"),
  device   = "pdf",
  width    = 12,
  height   = 8
)

```

### Heatmap 

- Heatmap (log2UMI) of the the HALLMARK_ANDROGEN_RESPONSE genes (to show its active despite the average signature score of ~0.2)
```{r Heatmap: log2UMI - HALLMARK_ANDROGEN_RESPONSE - G1 cells only - both patient - split by PDOX/PDOXO}

# Global variables
patient_ids = unique(sce_obj$Model_ID)
signature_name = paste0("HALLMARK_ANDROGEN_RESPONSE","_gene")
genes_on_Heatmap = rownames(sce_obj)[rowData(sce_obj)[,signature_name]]

# Create a randomly selected sce woith 300 cells per sample
set.seed(123)

# Select only cells in G1 then perform downsampling
sce_obj_downsampled = sce_obj[,which(sce_obj$cell_cycle_phase == "G1")]
sce_obj_downsampled = downsample_sce(sce = sce_obj, group_column = "Clean_ID", n_per_group = 300)

# Make list of sce objects by patient
#####################################

sce_list = lapply(patient_ids, function(pid){
  
  sce_obj = sce_obj_downsampled[genes_on_Heatmap, which(sce_obj_downsampled$Model_ID == pid)]
  col_order = order(sce_obj$Model_System, sce_obj$Clean_ID)
  sce_obj_patient = sce_obj[,col_order]
  return(sce_obj_patient)
  
}
)

names(sce_list) <- patient_ids # Name according patient_id

# Make list of logCounts expression matrix by patient
#####################################################

expr_list <- lapply(patient_ids, function(pid) {
  
  expr_mat = logcounts(sce_list[[pid]])
  expr_mat = as.matrix(expr_mat)
  return(expr_mat)
  
})

names(expr_list) <- patient_ids # Name according patient_id


# Make list of top annotation by patient
########################################

anno_list <- lapply(patient_ids, function(pid) {
  
  HeatmapAnnotation(
    Clean_ID = factor(sce_list[[pid]]$Short_ID),
    col = list(Clean_ID = pal.PDOX.PDOXO.updated.short.id),
    show_annotation_name = FALSE,
    show_legend = TRUE
  )
}
)


# Row font size
################

row_fontsize <- case_when(
  length(genes_on_Heatmap) >= 150 ~ 4,
  length(genes_on_Heatmap) >= 100 ~ 5,
  length(genes_on_Heatmap) >= 50 ~ 6,
  TRUE ~ 7
)

# Map function to make heatmap on the different list of objects

heatmap_list <- Map( function(sce, mtx, pid, anno) {
  
ht <- Heatmap(
  
  matrix = mtx,
  name   = "HALLMARK_ANDROGEN_RESPONSE",

  # === Colors & values ===
  col = pal.log2,

  # === Titles & labels ===
  column_title_gp = gpar(fontsize = row_fontsize + 4, fontface = "bold"),
  row_title_gp    = gpar(fontsize = row_fontsize + 3, fontface = "bold"),
  row_names_gp    = gpar(fontsize = row_fontsize),

  # === Row settings ===
  cluster_rows   = TRUE,
  show_row_dend  = FALSE,
  show_row_names = TRUE,

  # === Column settings ===
  cluster_columns  = TRUE,
  show_column_dend = FALSE,
  show_column_names = FALSE,
  column_split = factor(
    sce$Model_System,
    levels = c("Xenograft", "Xenograft_Organoids")
  ),
  cluster_column_slices = FALSE,

  # === Annotations ===
  top_annotation = anno,

  # === Rendering options ===
  use_raster      = TRUE,
  raster_quality  = 2,
  width           = unit(6, "inch"),

  # === Legend ===
  heatmap_legend_param = list(
    title = "log2(UMI)",
    # direction = "vertical",
    # title_position = "topcenter",
    legend_width = unit(4, "cm")
  )
)
}, 

# Objects on which the heatmap function will be mapped
sce_list, expr_list, names(expr_list), anno_list)

{
  
  # Save the combined plot
  pdf(
    file = paste0(out_path, time_stamp(), "Split_by_Patient_Heatmap_",signature_name,".pdf"),
    width = 16, height = 10
  )
  
  draw(
    heatmap_list[[1]]  + heatmap_list[[2]],
    gap = unit(1, "inch"),
    padding = unit(c(1, 1, 1, 1), "inch"),
    merge_legend = F
  )
  
  dev.off()
  
}

```

- Heatmap (z_score) of the the HALLMARK_ANDROGEN_RESPONSE genes (to show its active despite the average signature score of ~0.2)
```{r Heatmap: zscore- HALLMARK_ANDROGEN_RESPONSE - G1 cells only - both patient - split by PDOX/PDOXO}

# Make list of zscore matrix by patient
########################################

z_list <- lapply(patient_ids, function(pid){
  
  z_expr_mtx = t(scale(t(expr_list[[pid]])))
  z_expr_mtx[is.na(z_expr_mtx)] <- 0
  
  return(z_expr_mtx)
}
)

names(z_list) <- patient_ids # Name according patient_id

dist_plot = hist(z_list$`P20-11`,breaks = 100)
plot(dist_plot)


# Map function to make heatmap on the different list of objets
#############################################################

heatmap_list <- Map( function(sce, mtx, pid, anno) {
  
ht <- Heatmap(
  matrix = mtx,
  name   = "z_score",

  # === Colors & scaling ===
  col = circlize::colorRamp2(
    breaks = c(-3, 0, 5),       # or symmetric c(-3, 0, 3) depending on data distribution
    colors = c("darkblue", "white", "darkred")
  ),

  # === Titles & text ===
  column_title_gp = gpar(fontsize = row_fontsize + 4, fontface = "bold"),
  row_title_gp    = gpar(fontsize = row_fontsize + 3, fontface = "bold"),
  row_names_gp    = gpar(fontsize = row_fontsize),

  # === Row settings ===
  cluster_rows   = TRUE,
  show_row_dend  = FALSE,
  show_row_names = TRUE,

  # === Column settings ===
  cluster_columns   = TRUE,
  show_column_dend  = FALSE,
  show_column_names = FALSE,
  column_split = factor(
    sce$Model_System,
    levels = c("Xenograft", "Xenograft_Organoids")
  ),
  cluster_column_slices = FALSE,

  # === Annotations ===
  top_annotation = anno,

  # === Rendering options ===
  use_raster     = TRUE,
  raster_quality = 2,
  width          = unit(6, "inch"),

  # === Legend ===
  heatmap_legend_param = list(
    title            = "Z_scores",
    direction        = "horizontal",
    title_position   = "topcenter",
    legend_width     = unit(4, "cm")
  )
)

}, 

# Objects on which the heatmap function will be mapped
sce_list, z_list, names(z_list), anno_list)

{
  
  # Save the combined plot
  pdf(
    file = paste0(out_path, time_stamp(), "Split_by_Patient_Heatmap_",signature_name,"_Zscores.pdf"),
    width = 16, height = 10
  )
  
  draw(
    heatmap_list[[1]]  + heatmap_list[[2]],
    gap = unit(1, "inch"),
    padding = unit(c(1, 1, 1, 1), "inch"),
    merge_legend = F
  )
  
  dev.off()
  
}

```

